From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Siroshun09 <siro.shun8@gmail.com>
Date: Thu, 22 Jun 2023 11:53:26 +0900
Subject: [PATCH] Re-add some events

- EntityPortalReadyEvent
- spawn/respawn events (that cannot modify the location)
- PlayerChangedWorldEvent

diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index 79009dfa6edafb1e5ee0d475a1a02e7e8bca4a55..6362eb1572eebc8794353896452c8bcf3beb7f4f 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -1298,10 +1298,15 @@ public class ServerPlayer extends Player {
 
         this.respawn((player) -> {
             CriteriaTriggers.CHANGED_DIMENSION.trigger(player, Level.END, Level.OVERWORLD);
+            new org.bukkit.event.player.PlayerRespawnEvent(player.getBukkitEntity(), player.getBukkitEntity().getLocation(), false, false, org.bukkit.event.player.PlayerRespawnEvent.RespawnReason.END_PORTAL, com.google.common.collect.ImmutableSet.<org.bukkit.event.player.PlayerRespawnEvent.RespawnFlag>builder().add(org.bukkit.event.player.PlayerRespawnEvent.RespawnFlag.END_PORTAL)).callEvent(); // okocraft - call PlayerRespawnEvent
         }, true);
     }
 
     public void respawn(java.util.function.Consumer<ServerPlayer> respawnComplete) {
+        // okocraft start - call PlayerRespawnEvent
+        java.util.function.Consumer<ServerPlayer> calling = player -> new org.bukkit.event.player.PlayerRespawnEvent(player.getBukkitEntity(), player.getBukkitEntity().getLocation(), false, false, org.bukkit.event.player.PlayerRespawnEvent.RespawnReason.DEATH, com.google.common.collect.ImmutableSet.builder()).callEvent(); // okocraft - call PlayerRespawnEvent
+        respawnComplete = respawnComplete != null ? respawnComplete.andThen(calling) : calling;
+        // okocraft end
         this.respawn(respawnComplete, false);
     }
 
@@ -1566,6 +1571,7 @@ public class ServerPlayer extends Player {
 
             this.connection.send(new ClientboundLevelEventPacket(net.minecraft.world.level.block.LevelEvent.SOUND_PORTAL_TRAVEL, BlockPos.ZERO, 0, false)); // okocraft - Fix not playing travel sound when changing the dimension by portals
             this.triggerDimensionChangeTriggers(originWorld);
+            new org.bukkit.event.player.PlayerChangedWorldEvent(this.getBukkitEntity(), originWorld.getWorld()).callEvent(); // okocraft - Call PlayerChangedWorldEvent
 
             // finished
 
diff --git a/src/main/java/net/minecraft/server/players/PlayerList.java b/src/main/java/net/minecraft/server/players/PlayerList.java
index 5d4876fc53eb12ee8e4a0159177e05cee847f077..299616c19765463bb045401cea7141d50dea1a34 100644
--- a/src/main/java/net/minecraft/server/players/PlayerList.java
+++ b/src/main/java/net/minecraft/server/players/PlayerList.java
@@ -310,6 +310,9 @@ public abstract class PlayerList {
             worldserver1 = worldserver;
         }
 
+        // okocraft start - Call PlayerSpawnLocationEvent that cannot modify spawn location
+        this.cserver.getPluginManager().callEvent(new org.spigotmc.event.player.PlayerSpawnLocationEvent(player.getBukkitEntity(), worldserver1.getWorld().getSpawnLocation()));
+        // okocraft end
         // Paper start
         if (nbttagcompound == null) {
             player.spawnReason = org.bukkit.event.entity.CreatureSpawnEvent.SpawnReason.DEFAULT; // set Player SpawnReason to DEFAULT on first login
diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index cc4eb106b3ff1953de11f1faa7c04f3f9982fca2..80e4bc9444f5c870b3924b5e1347e174af7a901f 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -4110,12 +4110,21 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource, S
         io.papermc.paper.util.TickThread.ensureTickThread(this, "Cannot portal entity async");
 
         ServerLevel destination = this.getServer().getLevel(this.level().getTypeKey() == LevelStem.NETHER ? Level.OVERWORLD : Level.NETHER);
+        // okocraft start - call EntityPortalReadyEvent
+        io.papermc.paper.event.entity.EntityPortalReadyEvent event = new io.papermc.paper.event.entity.EntityPortalReadyEvent(this.getBukkitEntity(), destination == null ? null : destination.getWorld(), org.bukkit.PortalType.NETHER);
+        if (!event.callEvent()) {
+            this.portalTime = 0;
+            return false;
+        } else {
+            destination = event.getTargetWorld() == null ? null : ((CraftWorld) event.getTargetWorld()).getHandle();
+        // okocraft end
         if (destination == null) {
             // wat
             return false;
         }
 
         return this.portalToAsync(destination, false, PortalType.NETHER, null);
+        } // okocraft - call EntityPortalReadyEvent
     }
 
     private static final java.util.concurrent.atomic.AtomicLong CREATE_PORTAL_DOUBLE_CHECK = new java.util.concurrent.atomic.AtomicLong();
