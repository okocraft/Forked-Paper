From 0000000000000000000000000000000000000000 Mon Sep 17 00:00:00 2001
From: Siroshun09 <siro.shun8@gmail.com>
Date: Thu, 22 Jun 2023 11:53:26 +0900
Subject: [PATCH] Re-add some events

- EntityPortalReadyEvent
- spawn/respawn events (that cannot modify the location)
- PlayerChangedWorldEvent

diff --git a/src/main/java/net/minecraft/server/level/ServerPlayer.java b/src/main/java/net/minecraft/server/level/ServerPlayer.java
index 79009dfa6edafb1e5ee0d475a1a02e7e8bca4a55..174b6d92cb28ded6d12e506ee9d36b62a0795689 100644
--- a/src/main/java/net/minecraft/server/level/ServerPlayer.java
+++ b/src/main/java/net/minecraft/server/level/ServerPlayer.java
@@ -1298,10 +1298,15 @@ public class ServerPlayer extends Player {
 
         this.respawn((player) -> {
             CriteriaTriggers.CHANGED_DIMENSION.trigger(player, Level.END, Level.OVERWORLD);
+            new org.bukkit.event.player.PlayerRespawnEvent(player.getBukkitEntity(), player.getBukkitEntity().getLocation(), false, false, org.bukkit.event.player.PlayerRespawnEvent.RespawnReason.END_PORTAL, com.google.common.collect.ImmutableSet.<org.bukkit.event.player.PlayerRespawnEvent.RespawnFlag>builder().add(org.bukkit.event.player.PlayerRespawnEvent.RespawnFlag.END_PORTAL)).callEvent(); // okocraft - Call PlayerRespawnEvent
         }, true);
     }
 
     public void respawn(java.util.function.Consumer<ServerPlayer> respawnComplete) {
+        // okocraft start - Call PlayerRespawnEvent
+        java.util.function.Consumer<ServerPlayer> calling = player -> new org.bukkit.event.player.PlayerRespawnEvent(player.getBukkitEntity(), player.getBukkitEntity().getLocation(), false, false, org.bukkit.event.player.PlayerRespawnEvent.RespawnReason.DEATH, com.google.common.collect.ImmutableSet.builder()).callEvent();
+        respawnComplete = respawnComplete != null ? respawnComplete.andThen(calling) : calling;
+        // okocraft end - Call PlayerRespawnEvent
         this.respawn(respawnComplete, false);
     }
 
@@ -1566,6 +1571,7 @@ public class ServerPlayer extends Player {
 
             this.connection.send(new ClientboundLevelEventPacket(net.minecraft.world.level.block.LevelEvent.SOUND_PORTAL_TRAVEL, BlockPos.ZERO, 0, false)); // okocraft - Fix not playing travel sound when changing the dimension by portals
             this.triggerDimensionChangeTriggers(originWorld);
+            new org.bukkit.event.player.PlayerChangedWorldEvent(this.getBukkitEntity(), originWorld.getWorld()).callEvent(); // okocraft - Call PlayerChangedWorldEvent
 
             // finished
 
diff --git a/src/main/java/net/minecraft/server/players/PlayerList.java b/src/main/java/net/minecraft/server/players/PlayerList.java
index 5d4876fc53eb12ee8e4a0159177e05cee847f077..68698698d0eb45113ee7f71f6d1f6d3e8e036866 100644
--- a/src/main/java/net/minecraft/server/players/PlayerList.java
+++ b/src/main/java/net/minecraft/server/players/PlayerList.java
@@ -350,9 +350,10 @@ public abstract class PlayerList {
         // Spigot start - spawn location event
         Player spawnPlayer = player.getBukkitEntity();
         org.spigotmc.event.player.PlayerSpawnLocationEvent ev = new com.destroystokyo.paper.event.player.PlayerInitialSpawnEvent(spawnPlayer, spawnPlayer.getLocation()); // Paper use our duplicate event
+        ev.callEvent(); // okocraft - Call PlayerSpawnLocationEvent that cannot modify spawn location
         //this.cserver.getPluginManager().callEvent(ev); // Folia - region threading - TODO WTF TO DO WITH THIS EVENT?
 
-        Location loc = ev.getSpawnLocation();
+        Location loc = spawnPlayer.getLocation(); // okocraft -  Call PlayerSpawnLocationEvent; Prevents the spawn location from being changed
         worldserver1 = ((CraftWorld) loc.getWorld()).getHandle();
 
         player.spawnIn(worldserver1);
diff --git a/src/main/java/net/minecraft/world/entity/Entity.java b/src/main/java/net/minecraft/world/entity/Entity.java
index 363a1bec9f6e22fb43a3c4d8e993633a1c2e0035..e8b624c95687b68238e5b85f2addc6a876e71e83 100644
--- a/src/main/java/net/minecraft/world/entity/Entity.java
+++ b/src/main/java/net/minecraft/world/entity/Entity.java
@@ -4110,12 +4110,21 @@ public abstract class Entity implements Nameable, EntityAccess, CommandSource, S
         io.papermc.paper.util.TickThread.ensureTickThread(this, "Cannot portal entity async");
 
         ServerLevel destination = this.getServer().getLevel(this.level().getTypeKey() == LevelStem.NETHER ? Level.OVERWORLD : Level.NETHER);
+        // okocraft start - Call EntityPortalReadyEvent
+        io.papermc.paper.event.entity.EntityPortalReadyEvent event = new io.papermc.paper.event.entity.EntityPortalReadyEvent(this.getBukkitEntity(), destination == null ? null : destination.getWorld(), org.bukkit.PortalType.NETHER);
+        if (!event.callEvent()) {
+            this.portalTime = 0;
+            return false;
+        } else {
+            destination = event.getTargetWorld() == null ? null : ((CraftWorld) event.getTargetWorld()).getHandle();
+        // okocraft end - Call EntityPortalReadyEvent
         if (destination == null) {
             // wat
             return false;
         }
 
         return this.portalToAsync(destination, false, PortalType.NETHER, net.okocraft.paper.PortalLevelEventSender.INSTANCE); // okocraft - Fix not playing travel sound when changing the dimension by portals
+        } // okocraft - Call EntityPortalReadyEvent
     }
 
     private static final java.util.concurrent.atomic.AtomicLong CREATE_PORTAL_DOUBLE_CHECK = new java.util.concurrent.atomic.AtomicLong();
